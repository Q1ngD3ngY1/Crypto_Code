import math
import numpy as np
import gmpy2 as gy

X_star = [5500,125,175,65,2000]
Ground_truth = [6610,125,175,70,1946]
USER_NUM = 10
TASK_NUM = 5

user_data = [[4000,125,174,76,2000],
             [4871,123,180,80,1738],
             [10000,130,176,70,3000],
             [7000,120,170,50,1500],
             [7190,127,190,75,1500],

             [6800,127,168,71,1960],
             [6765,123,177,73,1955],
             [7000,120,188,70,1899],
             [6500,130,175,71,1900],
             [6610,125,176,74,1950]]
task_data =[[4000, 4871, 10000, 7000, 7190, 6800, 6765, 7000, 6500, 6610], 
            [125, 123, 130, 120, 127, 127, 123, 120, 130, 125], 
            [174, 180, 176, 170, 190, 168, 177, 188, 175, 176], 
            [76, 80, 70, 50, 75, 71, 73, 70, 71, 74], 
            [2000, 1738, 3000, 1500, 1500, 1960, 1955, 1899, 1900, 1950]]

alpha = [[22410642974084585442191727643918586647230232556525075962101709016346283694569, 
         68574235962049804543682472313140990616965871425187131346222779247232111250905, 
         43139019699327115711617780202783040092862808628341895782744823069479854552953, 
         107077420960787047367844643446953157544199051322244644306625049394723563232185, 
         16523082419060126492750584071126670442347370916635012443244906593568651899054],
         [101695400669583813810746445139700392985776378025001584089118250770932796907834, 
           73764177157514071151095645437026121983640638485837445471844106164793206724575, 
           47612803961517067692539903164155489886296618497839475581217124605877787757442, 
           109689469928430497140731974242430685833999201365656390582176427565993107439132, 
           92925713401400710623839810079810339180963862369432977099052206202543808421338],
           [63522566125187066556456764927373909912726211284218421011246448508692892883960, 
           2409208470116330926832310305110493054977239499386296942801684715449791849710, 
           113517673626352500141239206018899500102813717310384125436766574738317857361980, 
           37375605603684302646951325006261092494073445795806255322644516033219539977589, 
           114880691687877779925881942767867221717253840071213558427380246744809174197327],
           [62312548736497453480832483456650982941473578796180777137784969230386548643384, 
           64054305960678500929777904083234938546857537972919801355215258591653013196486, 
           19835137876183337719973403408040362000981861846821393735688467352621159088332, 
           18746778741407973218597871561523148403714854963385195740040441598826397863894, 
           20201604210824322513505661740215815043165403993207115450011218751649201516349],
           [29570929772973349417968750706070689975526920770033625399115048062619150992298, 
           96784599580189734353569887609390758722769477223581924642005694087560629449912, 
           21077299056370535147157222341468262036561137739159405038991391911128092007265, 
           69473945125418599488020607054720093749407458904586736888715945536961994897683, 
           18773976058461958245909423671154077797152685511502714027189255601719507001640],
           
           [7132786843348027683509617106225935391508638737748699303820358533878852119799, 
            22202262115476576703143786724310994167269882708038512642473923066476527453120, 
            9846327241871927141663034382109014318524218773305585705416150605338346338779, 
            104865901099009032230511445046932151521771363669490606038609407856879688045376, 
            63388054285808307401188397777640847331427019695417334808191053678473067907114],
            [65409304011354047237186567709588712533172325026467698363593724213142926988343, 
             112842395804061866533073652196090434308350830110184467533442888048301276525193, 
             22167638407458087456909011333524897573126473603610239756816857648794079344169, 
             44328431963488937666383030730779073358015421103939273396866799542612616315874, 
             104562966334847411476092532616950370438425171227329215456075892387002477874973],
             [82311233059362826292536458877051790059863656700534136836280522182928647995503, 
              85570166055603503963241492763829970922073310076502773750400818987063390197163, 
              50581398802476747285065499181964945506412184399799615686276017128518175627321, 
              40134484064243320410604578954571590973131345465333677911899673185710823132668, 
              104545717417648121169975128314758727909304342625913470898014862589977113121163],
              [48623361593403789316428535969317064530714456201628671361639035403693876576704, 
               80784874429251842388832045434779236362764810205959439166878424611570650297881, 
               58352991835940127247214466748328378337271782853490820375504749954439872709319, 
               10827998448947705453740509451623197092332146734030359153145444172475834481420, 
               42206922366291643865051189848072143512302276533955325280189998516140809922759],
               [55938223678457320586225977217529546577844133102439334408923560983580220520083, 
                2848921631326935200510353395593829839243358619998526618662089992347765320249, 
                59698045928224943307611385018635183240445175697043564943040187109900517325414, 
                101453691664314943360165983077445994137973893060623835039764909777617875232048, 
                58318025073374684892780175626710443450628931464012007176340940024729693377047]]

beta = [[28980071573958870104037448878024028088160745280007090543572922948399743223574,
           33139158635280479122274132831031359665113727632219694222950788328085693181410,
           113816394004688601150528090287525212800032701712922521551766913094553835528223,
           65594187901183430241063731711970678217864934574787255973595560011488206767343,
           109252183464698737078048216856005366090937751419708158368495792126034518534683],
          [87468985639193200204652382776922455155978923674257360185168157474504560858263,
          80166940359038904135528364952651696443381543854342527267691091996323672605115,
          20206416421525942267390070576557872171492087098762772930928381493146603982273,
          64264579778530331717156201147611161587400239306171628421438811949913256582970,
          21502485423969320067247547456603912717579681938850094861774603724058836203602],
          [46344856186173467272898240559849920793790598949574461371906004659936266822979,
          112140187322440122230681862095165195212844584492018656010808428299290132072623,
          88115782566714359615439687828220094356274061224856695930760899234766818322954,
          110789876659046408686837931351343322372925125885482045583309570965386253006211,
          63952680364485994300203450020808374199539178352929058644228656469994458542071],
          [66504964718850614041704920051542305976268673419431147076004143145295262572440,
          104149630161811114853033937900808168906595392548438125024921823912857472618006,
          103279894290749185962022763791688315738502822151212067547591163133720161696826,
          85418319297450639457400768279929166150558147519449379996885150505798688888557,
          104700106344889180522738960574884169072232362553986772007002533363798823055337],
          [91299469577566590612718144730254116681727044002277477614703629434177433088924,
          50892887058024657626675136424924706428542538274789976899467205399446477304139,
          40455201460877408267539234675054112696886973918587350082220095198534183617573,
          88533991388170759499413950010563116659633130282890565587093792389644625972193,
          108717517998839997253439341621199086403854356722384118754707487463856226997624],

          [96321293975927783042755880974012365462486511548389427413880533021415785828647,
           32295264156250754037379539127125596355229423196840927830020996252215304451424,
           104015976305374213487156936919558085635847423616431487509371110860196453355119,
           1927848903312200124407224393725963287283279889021393722717635832214325351570,
           112407580592866959566413877103054288208524060571745656063992838439106767322136],
          [54286373262562556670580938703370275961482308613285556062877940790046781126521,
           20004169971914524100593854304258646114472112146779022197057521060187680087127,
           74642456514174140162419785535933875638930944488393735368715787701550273644075,
           100391023996677774450139666603654449135568499842947533250806957967766542256914,
           27888776210513250873461981894252006283077512951025007731675573997273515765317],
          [110180133817184662452555577611165948839805606930689594887879427611356726889947,
           78882164405312301393327820044349331616172297694294737816979049271236176750785,
           20004731623323282258916464610981775914040684507991422081449368753792096286832,
           20280549304013778808123239657739852040402032642344166058664711198377691476051,
           23022056077300307420337509688178325057800577682106719746526978289664737973772],
          [56491329743185313365025024163899770022593081737829396913742912148448574906337,
            59490995034040151603928431097351184670106782225238471472969684750200903334072,
            15954810165928736530858278317025056892773476064894417903830115630342092396253,
            64618682483707902338863733877281433249107879768726184738131695303794939262625,
            39414674421319356654742859949810263106225945099275650286508756068131563751179],
          [69766228847338406856114642042038511352133049481000187469940606987477876396930,
           47569794994711694250402744836489876468849262736763310595190892451520800977961,
           82217723262927383396885837911933005444785749546432700844394020082898556083997,
           45343132719980088639873441908743758307497650772970009011884770002659969242829,
           42817864130031781097020296655482382494814507766733064213660052522876345890792]]


M_1 = [[115920286295835480416149795512096112352642981120028362174291691793598972894296000,
        4142394829410059890284266603878919958139215954027461777868848541010711647676250,
        19804052556815816600191887710029387027205690098048518750007442878452367381910802,
        4985158280489940698320843610109771544557735027683831453993262560873103714318068,
        218504366929397474156096433712010732181875502839416316736991584252069037069366000],
       [426061429048510078196861756506389279064773337217307601461954095058311715940599073,
        9860533664161785208669988889176158662535929894084130853926004315547811730429145,
        3637154955874669608130212703780416990868575677777299127567108668766388716809140,
        5141166382282426537372496091808892926992019144493730273715104955993060526637600,
        37371319666858678276876237479577600303153487209721464869764261272414257321860276],
       [463448561861734672728982405598499207937905989495744613719060046599362668229790000,
        14578224351917215889988642072371475377669795983962425281405095678907717169440990,
        15508377731741727292317385057766736606704234775574778483813918265318960024839904,
        7755291366133248608078655194594032566104758811983743190831669967577037710434770,
        191858041093457982900610350062425122598617535058787175932685969409983375626213000],
       [465534753031954298291934440360796141833880713936018029532029002017066838007080000,
        12497955619417333782364072548096980268791447105812575002990618869542896714160720,
        17557582029427361613543869844587013675545479765706051483090497732732427488460420,
        4270915964872531972870038413996458307527907375972468999844257525289934444427850,
        157050159517333770784108440862326253608348543830980158010503800045698234583005500],
       [656443186262703786505443460610527098941617446376375064049719095631735743909363560,
        6463396656369131518587742325965437716424902360898327066232335085729702617625653,
        7686488277566707570832454588260281412408525044531596515621818087721494887338870,
        6640049354112806962456046250792233749472484771216792419032034429223346947914475,
        163076276998259995880159012431798629605781535083576178132061231195784340496436000],

       [654984799036308924690739990623284085144908278529048106414387624545627343634799600,
        4101498547843845762747201469144950737114136745998797834412666524031343665330848,
        17474684019302867865842365402485758386822367167560489901574346624513004163659992,
        136877272135166208832912931954543393397112872120518954312952144087217099961470,
        220318857962019240750171199121986404888707158720621485885425963340649263951386560],
       [367247315121235695876480050328299916879427817768876786765369269444666474320914565,
        2460512906545486464373044079423813472080069794053819730238075090403084650716621,
        13211714803008822808748302039860295988090777174445691160262694423174398435001275,
        7328544751757477534860195662066774786896500488535169927308907931646957584754722,
        54522557491553405457618174603262672283416537819253890115425747164669723321194735],
       [771260936720292637167889043278161641878639248514827164215155993279497088229629000,
        9465859728637476167199338405321919793940675723315368538037485912548341210094200,
        3760889545184777064676295346864573871839648687502387351312481325712914101924416,
        1419638451280964516568626776041789642828142284964091624106529783886438403323570,
        43718884490793283791220930897850639284763297018320660798654731772073337412193028],
       [367193643330704536872662657065348505146855031295891079939328928964915736891190500,
        7733829354425219708510696042655654007113881689281001291486059017526117433429360,
        2792091779037528892900198705479384956235358311356523133170270235309866169344275,
        4587926456343261066059325105286981760686659463579559116407350366569440687646375,
        74887881400506777644011433904639499901829295688623735544366636529449971127240100],
       [453480487507699644564745173273250323788864821626501218554613945418606196580045000,
        6184073349312520252552356828743683940950404155779230377374816018697704127134930,
        14388101571012292094455021634588275952837506170625722647768953514507247314699475,
        3219362423118586293431014375520806839832333204880870639843818670188857816240859,
        81353941847060384084338563645416526740147564756792822005954099793465057192504800]]

M_2 = [[22410642974084585442191727643918586647230232556525075962101709016346283698569,
        68574235962049804543682472313140990616965871425187131346222779247232111251030,
        43139019699327115711617780202783040092862808628341895782744823069479854553127,
        107077420960787047367844643446953157544199051322244644306625049394723563232261,
        16523082419060126492750584071126670442347370916635012443244906593568651901054],
       [101695400669583813810746445139700392985776378025001584089118250770932796912705,
        73764177157514071151095645437026121983640638485837445471844106164793206724698,
        47612803961517067692539903164155489886296618497839475581217124605877787757622,
        109689469928430497140731974242430685833999201365656390582176427565993107439212,
        92925713401400710623839810079810339180963862369432977099052206202543808423076],
       [63522566125187066556456764927373909912726211284218421011246448508692892893960,
        2409208470116330926832310305110493054977239499386296942801684715449791849840,
        113517673626352500141239206018899500102813717310384125436766574738317857362156,
        37375605603684302646951325006261092494073445795806255322644516033219539977659,
        114880691687877779925881942767867221717253840071213558427380246744809174200327],
       [62312548736497453480832483456650982941473578796180777137784969230386548650384,
        64054305960678500929777904083234938546857537972919801355215258591653013196606,
        19835137876183337719973403408040362000981861846821393735688467352621159088502,
        18746778741407973218597871561523148403714854963385195740040441598826397863944,
        20201604210824322513505661740215815043165403993207115450011218751649201517849],
       [29570929772973349417968750706070689975526920770033625399115048062619150999488,
        96784599580189734353569887609390758722769477223581924642005694087560629450039,
        21077299056370535147157222341468262036561137739159405038991391911128092007455,
        69473945125418599488020607054720093749407458904586736888715945536961994897758,
        18773976058461958245909423671154077797152685511502714027189255601719507003140],

       [7132786843348027683509617106225935391508638737748699303820358533878852126599,
        22202262115476576703143786724310994167269882708038512642473923066476527453247,
        9846327241871927141663034382109014318524218773305585705416150605338346338947,
        104865901099009032230511445046932151521771363669490606038609407856879688045447,
        63388054285808307401188397777640847331427019695417334808191053678473067909074],
       [65409304011354047237186567709588712533172325026467698363593724213142926995108,
        112842395804061866533073652196090434308350830110184467533442888048301276525316,
        22167638407458087456909011333524897573126473603610239756816857648794079344346,
        44328431963488937666383030730779073358015421103939273396866799542612616315947,
        104562966334847411476092532616950370438425171227329215456075892387002477876928],
       [82311233059362826292536458877051790059863656700534136836280522182928648002503,
        85570166055603503963241492763829970922073310076502773750400818987063390197283,
        50581398802476747285065499181964945506412184399799615686276017128518175627509,
        40134484064243320410604578954571590973131345465333677911899673185710823132738,
        104545717417648121169975128314758727909304342625913470898014862589977113123062],
       [48623361593403789316428535969317064530714456201628671361639035403693876583204,
        80784874429251842388832045434779236362764810205959439166878424611570650298011,
        58352991835940127247214466748328378337271782853490820375504749954439872709494,
        10827998448947705453740509451623197092332146734030359153145444172475834481491,
        42206922366291643865051189848072143512302276533955325280189998516140809924659],
       [55938223678457320586225977217529546577844133102439334408923560983580220526583,
        2848921631326935200510353395593829839243358619998526618662089992347765320379,
        59698045928224943307611385018635183240445175697043564943040187109900517325589,
        101453691664314943360165983077445994137973893060623835039764909777617875232119,
        58318025073374684892780175626710443450628931464012007176340940024729693378947]]








#真值更新辅助函数
def truth_update_auxi(weight,m_1):
    data_weighted_perbed = []
    
    #求所有感知用户的权值之和
    weight_sum = 0
    for k in range(USER_NUM):
        weight_sum += weight[k]

    #求带扰动的带权数据
    for k in range(USER_NUM):
        sub_dwp = []
        for m in range(TASK_NUM):    
            sub_dwp.append(weight[k] * m_1[k][m])
        data_weighted_perbed.append(sub_dwp)

    return weight_sum,data_weighted_perbed

#真值更新函数
def truth_update(w_sum,data_w_p,beta):
    
    #计算加权数据
    data_weighted = []
    for k in range(USER_NUM):
        sub_dw = []
        for m in range(TASK_NUM):
            sub_dw.append(data_w_p[k][m] / beta[k][m])
        data_weighted.append(sub_dw)
    #print(data_weighted)

    #计算每个感知任务的真值
    x_star = []                 #本轮感知任务的真值列表
    for m in range(TASK_NUM):
        data_weighted_sum = 0
        for k in range(USER_NUM):
            data_weighted_sum += data_weighted[k][m]
        x_m_star = data_weighted_sum / w_sum
        x_star.append(int(x_m_star))
    return data_weighted,x_star

#权值更新辅助函数
def weight_update_auxi(m_2,x_star):
    dist_auxi = []
    for k in range(USER_NUM):                   #计算每个用户的dist_auxi
        sub_da = []
        for m in range(TASK_NUM):                      #计算每个用户每个任务的dist_auxi
            sub_da.append(m_2[k][m]-x_star[m])
        #print(sub_da)
        dist_auxi.append(sub_da)
    return dist_auxi

#权值更新
def weight_update(dist_auxi,a):
    #计算x_m_k - x_m_*
    percedata_sub_groundata = []
    for k in range(USER_NUM):
        sub_per = []
        for m in range(TASK_NUM):
            sub_per.append(dist_auxi[k][m] - a[k][m])
        #print(sub_per)
        percedata_sub_groundata.append(sub_per)
    
    #计算每个感知用户对于每个任务数据的距离和
    dist_workersum = []                #每个用户的距离和
    for k in range(USER_NUM):
        tmp = 0
        for m in range(TASK_NUM):
            tmp += percedata_sub_groundata[k][m] ** 2
        dist_workersum.append(tmp)
    
    #开始更新每个用户的权值
    dist_sum = 0                                #所有用户的距离和
    weight = []
    for k in range(USER_NUM):
        dist_sum += dist_workersum[k]   
    for k in range(USER_NUM):
        weight.append(gy.mpfr(math.log2((dist_sum / dist_workersum[k]))))
    return weight
    
'''
w = [4.053828210337023, 6.329959808676942, 0.8144370371880749, 3.901744653175525, 3.588574355119819]
weight_sum,data_weighted_perbed = truth_update_auxi(w,M_1)
data_weighted,x_star = truth_update(weight_sum,data_weighted_perbed,beta)
dist_auxi = weight_update_auxi(M_2,x_star)
weight = weight_update(dist_auxi,alpha)
'''
#计算RMSE
def RMSE(pred,truth):
    y_pred = np.array(pred)
    y_truth = np.array(truth)
    squared_error = (y_pred - y_truth) ** 2
    rmse = np.sqrt(np.mean(squared_error))
    print(rmse/100)
    return rmse/100


#主函数
def main():
    w = [4.053828210337023, 6.329959808676942, 0.8144370371880749, 3.901744653175525, 3.588574355119819, 4.465367067921497, 4.54366733727989, 4.047240576591407, 5.209389012376964, 4.91969192118492]
    updated_truth = []
    updated_weight = w
    
    for i in range(40):
        weight_sum,data_weighted_perbed= truth_update_auxi(updated_weight,M_1)
        data_weighted,x_star = truth_update(weight_sum,data_weighted_perbed,beta)
        dist_auxi = weight_update_auxi(M_2,x_star)
        updated_weight = weight_update(dist_auxi,alpha)

        updated_truth = x_star
        print("%d interation truth:"%(i+1),updated_truth)
        print("%d interation weight:"%(i+1),updated_weight)
    #print(updated_truth)
    #print(updated_weight)
    return updated_truth
updated_truth = main()
RMSE(updated_truth,Ground_truth)

